# 语音识别功能说明

## 功能概述

聊天界面现已支持语音输入功能，用户可以通过麦克风直接说话，系统会自动将语音转换为文字并发送给AI助手。

---

## 技术实现

### 使用的技术
- **Web Speech API**：浏览器原生语音识别API
- **语言设置**：中文（zh-CN）
- **识别模式**：单次识别（说完即停）

### 支持的浏览器
✅ **Chrome / Edge**（推荐）
✅ **Safari**（macOS/iOS）
⚠️ **Firefox**（部分版本支持）
❌ **旧版IE**（不支持）

---

## 使用方法

### 1. 开始语音输入
1. 点击聊天输入框右侧的 **麦克风图标** 🎤
2. 浏览器会弹出"请求使用麦克风"权限提示
3. 点击"允许"授权麦克风访问
4. 麦克风图标变为红色并显示**停止图标**，开始录音

### 2. 说话
- 对着麦克风清晰地说出您的问题
- 例如："我最近胸闷气短，该做什么检查？"
- 例如："我想了解心电图检查的价格"

### 3. 自动识别与发送
- 说完后停顿1-2秒，系统会自动停止录音
- 识别结果会自动填入输入框
- 0.5秒后自动发送给AI助手
- 如果需要修改，可以在自动发送前快速点击输入框编辑

### 4. 手动停止
- 如果需要提前停止录音，再次点击麦克风图标（现在是停止图标）
- 已录制的语音会立即进行识别

---

## 功能特性

### ✅ 自动化流程
1. **一键录音**：点击麦克风即可开始
2. **自动识别**：说完自动停止并识别
3. **自动填充**：识别结果填入输入框
4. **自动发送**：0.5秒后自动发送消息

### ✅ 错误处理
- **权限被拒**：提示用户授权麦克风
- **识别失败**：显示错误信息，建议手动输入
- **不支持的浏览器**：提示切换到Chrome/Edge/Safari

### ✅ 用户体验
- **视觉反馈**：录音时麦克风图标变红并闪烁
- **状态提示**：控制台显示"语音识别已启动"/"已结束"
- **可中断**：随时点击停止按钮取消录音

---

## 使用场景

### 适合语音输入的情况
✅ 长段落描述症状时
✅ 手不方便打字时（如开车、做饭等）
✅ 需要详细描述病史时
✅ 移动设备上输入不便时

### 建议手动输入的情况
⚠️ 环境嘈杂时（识别准确率低）
⚠️ 涉及敏感信息时（如身份证号）
⚠️ 需要输入特殊符号时
⚠️ 网络不稳定时

---

## 代码实现细节

### 初始化语音识别
```javascript
function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN'; // 中文识别
        recognition.continuous = false; // 单次识别
        recognition.interimResults = false; // 不返回临时结果
        
        // 识别成功回调
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            // 填入输入框并自动发送
        };
        
        // 错误处理
        recognition.onerror = function(event) {
            alert('语音识别失败: ' + event.error);
        };
    }
}
```

### 切换录音状态
```javascript
function toggleVoiceRecording() {
    if (!isRecording) {
        // 开始录音
        recognition.start();
        isRecording = true;
        // 更新UI状态
    } else {
        // 停止录音
        recognition.stop();
        isRecording = false;
    }
}
```

### 事件流程
1. **onstart** → 控制台日志："语音识别已启动"
2. **用户说话** → 浏览器实时识别
3. **停顿检测** → 自动触发onresult事件
4. **onresult** → 获取识别文本 → 填入输入框 → 自动发送
5. **onend** → 控制台日志："语音识别已结束" → 恢复UI状态

---

## 权限管理

### 首次使用
- 浏览器会弹出权限请求
- 用户选择"允许"后才能使用
- 权限会保存，后续访问不再询问

### 权限被拒绝
1. 点击麦克风图标
2. 浏览器提示："语音识别失败: not-allowed"
3. 系统弹窗提示用户检查权限

### 重新授权
**Chrome/Edge**：
1. 点击地址栏左侧的锁图标
2. 找到"麦克风"权限
3. 选择"允许"
4. 刷新页面

**Safari**：
1. Safari → 偏好设置 → 网站 → 麦克风
2. 找到当前网站
3. 选择"允许"

---

## 测试场景

### 测试1：基础语音输入
1. 点击麦克风图标
2. 允许麦克风权限
3. 说："我最近头痛"
4. 观察：
   - ✅ 麦克风图标变红并闪烁
   - ✅ 识别结果"我最近头痛"填入输入框
   - ✅ 自动发送给AI
   - ✅ AI回复病症分析

### 测试2：长句子识别
1. 点击麦克风
2. 说："我最近胸闷气短，呼吸不畅，有时候还会出汗，请问需要做什么检查"
3. 观察：
   - ✅ 完整识别长句子
   - ✅ 标点符号自动添加
   - ✅ AI理解并回复【1. 疾病分析】【2. 检查项目】【3. 就医推荐】

### 测试3：手动停止
1. 点击麦克风
2. 说："我想了解..."（未说完）
3. 立即点击停止按钮
4. 观察：
   - ✅ 立即停止录音
   - ✅ 识别已说的部分
   - ✅ 可以编辑后发送

### 测试4：权限错误处理
1. 浏览器设置中禁用麦克风权限
2. 点击麦克风图标
3. 观察：
   - ✅ 弹出错误提示
   - ✅ 建议用户授权麦克风
   - ✅ 麦克风图标恢复正常

---

## 常见问题

### Q1: 为什么识别不准确？
**A:** 可能原因：
- 环境噪音过大（建议安静环境）
- 说话不清晰或太快（建议放慢语速）
- 方言口音较重（Web Speech API针对普通话优化）
- 麦克风质量问题

**解决方案**：
- 使用外接高质量麦克风
- 靠近麦克风说话
- 说话清晰、适中语速

### Q2: 为什么点击后没反应？
**A:** 检查：
1. 浏览器是否支持（使用Chrome/Edge）
2. 麦克风权限是否允许（查看地址栏图标）
3. 控制台是否有错误信息（F12打开开发者工具）

### Q3: 识别完能否修改后再发送？
**A:** 可以！识别完成后有0.5秒缓冲时间，快速点击输入框即可编辑，取消自动发送。

### Q4: 支持方言吗？
**A:** Web Speech API主要针对普通话优化，方言识别准确率较低。建议使用普通话输入。

### Q5: 能识别英文吗？
**A:** 当前设置为中文识别（zh-CN），英文识别效果不佳。如需英文识别，可修改代码中的 `recognition.lang = 'en-US'`。

---

## 隐私与安全

### 数据处理
- ✅ 语音识别在浏览器本地进行（部分浏览器使用云端API）
- ✅ 识别结果仅用于填充输入框
- ✅ 不存储录音文件
- ✅ 不上传原始音频到服务器

### 权限管理
- 🔒 用户必须主动授权麦克风
- 🔒 可随时撤销权限
- 🔒 权限仅限当前网站

### 建议
- 不要在公共场所使用语音输入敏感信息
- 使用后可在浏览器设置中撤销麦克风权限
- 定期检查浏览器权限设置

---

## 未来扩展

### 短期优化
1. ✅ 支持连续识别（continuous: true）
2. ✅ 显示实时识别结果（interimResults: true）
3. ✅ 添加语音动画波形显示
4. ✅ 支持多语言切换

### 中期优化
1. 集成更高级的语音识别API（如阶跃星辰语音API）
2. 支持方言识别
3. 噪音消除与增强
4. 语音情感分析

### 长期规划
1. 语音对话模式（全程语音交互）
2. 离线语音识别
3. 自定义医疗术语词库
4. 多人对话识别

---

## 相关文件

- `templates/chat.html` - 语音识别实现代码（+100行）
  - `initSpeechRecognition()` - 初始化函数
  - `toggleVoiceRecording()` - 录音控制函数
  - Web Speech API事件处理

---

## 测试步骤

1. 访问：http://127.0.0.1:5000/chat
2. 点击输入框右侧的麦克风图标 🎤
3. 允许浏览器麦克风权限
4. 对着麦克风说："我最近胸闷气短"
5. 观察识别结果自动填入输入框
6. 等待0.5秒自动发送或立即编辑

---

## 技术支持

- 浏览器兼容性：[Web Speech API支持情况](https://caniuse.com/speech-recognition)
- MDN文档：[SpeechRecognition API](https://developer.mozilla.org/zh-CN/docs/Web/API/SpeechRecognition)
- Chrome语音识别：需要网络连接（使用Google语音服务）

---

**语音识别功能已全面集成！** 🎤✨
