<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€¸ä»™æ™ºæ£€</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }

        /* å¤´éƒ¨ */
        .chat-header {
            background: #ffffff;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f0f0f0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-btn {
            background: transparent;
            border: none;
            color: #005826;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            background: #f0f9f4;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-title h1 {
            font-size: 20px;
            color: #005826;
            font-weight: 600;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            position: fixed;
            left: -320px;
            top: 0;
            width: 320px;
            height: 100vh;
            background: #ffffff;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.1);
            transition: left 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .sidebar.open {
            left: 0;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #262626;
        }

        .sidebar-close {
            background: transparent;
            border: none;
            color: #8c8c8c;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .sidebar-close:hover {
            background: #f0f0f0;
            color: #262626;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .new-chat-btn {
            width: 100%;
            background: #005826;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .new-chat-btn:hover {
            background: #00722f;
        }

        .history-section {
            margin-bottom: 24px;
        }

        .history-section-title {
            font-size: 12px;
            color: #8c8c8c;
            font-weight: 600;
            margin-bottom: 8px;
            padding: 0 8px;
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-item:hover {
            background: #f0f9f4;
        }

        .history-item.active {
            background: #e8f4ee;
            border-left: 3px solid #005826;
        }

        .history-item-icon {
            color: #005826;
            font-size: 16px;
        }

        .history-item-content {
            flex: 1;
            min-width: 0;
        }

        .history-item-title {
            font-size: 14px;
            color: #262626;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item-time {
            font-size: 12px;
            color: #8c8c8c;
            margin-top: 2px;
        }

        .history-item-delete {
            opacity: 0;
            color: #ff4d4f;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .history-item:hover .history-item-delete {
            opacity: 1;
        }

        .history-item-delete:hover {
            background: #fff1f0;
            color: #cf1322;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            z-index: 999;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .empty-history {
            text-align: center;
            padding: 40px 20px;
            color: #8c8c8c;
        }

        .empty-history i {
            font-size: 48px;
            color: #d9d9d9;
            margin-bottom: 12px;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .initial-view {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .initial-view.hidden {
            display: none;
        }

        .hero-section {
            margin-bottom: 40px;
        }

        .doctor-avatar {
            width: 200px;
            height: 200px;
            margin: 0 auto 30px;
            border-radius: 50%;
            overflow: hidden;
            background: #f0f9f4;
        }

        .doctor-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-title {
            font-size: 32px;
            font-weight: 600;
            color: #005826;
            margin-bottom: 10px;
        }

        .hero-subtitle {
            font-size: 18px;
            color: #595959;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        .quick-action-btn {
            background: white;
            color: #005826;
            border: 1px solid #005826;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(0, 88, 38, 0.1);
        }

        .quick-action-btn:hover {
            background: #005826;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 88, 38, 0.2);
        }

        .quick-action-btn.active {
            background: #00722f;
            color: white;
        }

        .quick-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .quick-option-chip {
            background: #f0f9f4;
            color: #005826;
            border: 1px solid #005826;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-option-chip:hover {
            background: #d4f0e0;
            transform: scale(1.05);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #005826;
            text-align: center;
            margin-bottom: 30px;
        }

        .disease-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .disease-card {
            background: #f0f9f4;
            border: 2px solid #d4f0e0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .disease-card:hover {
            background: #d4f0e0;
            border-color: #005826;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 88, 38, 0.2);
        }

        .disease-card-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .disease-card-title {
            font-size: 14px;
            color: #005826;
            font-weight: 500;
        }

        /* ç—‡çŠ¶è¡¨å•æ¨¡æ€çª—å£ */
        .symptom-form-modal {
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #005826;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #d4f0e0;
        }

        .form-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .form-option {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f0f9f4;
            border: 2px solid #d4f0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .form-option:hover {
            background: #d4f0e0;
            border-color: #005826;
        }

        .form-option input {
            margin-right: 10px;
            cursor: pointer;
        }

        .form-option label {
            cursor: pointer;
            font-size: 14px;
            color: #262626;
            flex: 1;
        }

        .form-submit-btn {
            width: 100%;
            background: #005826;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }

        .form-submit-btn:hover {
            background: #00722f;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 88, 38, 0.3);
        }

        .modal-custom-input {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .modal-input-label {
            font-size: 14px;
            color: #595959;
            margin-bottom: 10px;
            text-align: center;
        }

        .modal-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .modal-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #d4f0e0;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .modal-input:focus {
            border-color: #005826;
        }

        .modal-submit-btn {
            background: #005826;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .modal-submit-btn:hover {
            background: #00722f;
        }

        .messages-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .message {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #005826;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #f0f9f4;
            color: #005826;
        }

        .message-content {
            max-width: 60%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.6;
        }

        .message.user .message-content {
            background: #d4f0e0;
            color: #262626;
            border-radius: 12px 12px 4px 12px;
        }

        .message.assistant .message-content {
            background: white;
            color: #262626;
            border: 1px solid #005826;
            border-radius: 12px 12px 12px 4px;
        }

        .message-time {
            font-size: 12px;
            color: #8c8c8c;
            margin-top: 6px;
        }

        .message-image {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
            cursor: pointer;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #005826;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {

            0%,
            60%,
            100% {
                opacity: 0.3;
                transform: scale(0.8);
            }

            30% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input-area {
            background: white;
            border-top: 1px solid #f0f0f0;
            padding: 20px;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f5f5f5;
            border-radius: 12px;
            padding: 12px;
        }

        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            resize: none;
            font-size: 15px;
            line-height: 1.5;
            outline: none;
            max-height: 120px;
            font-family: inherit;
        }

        .input-btn {
            background: transparent;
            border: none;
            color: #005826;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .input-btn:hover {
            background: rgba(0, 88, 38, 0.1);
        }

        .input-btn.recording {
            color: #ff4d4f;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .send-btn {
            background: #005826;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #00722f;
        }

        .send-btn:disabled {
            background: #d9d9d9;
            cursor: not-allowed;
        }

        #imageInput {
            display: none;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* ä»·æ ¼å¯¹æ¯”å¡ç‰‡æ ·å¼ */
        .price-card-container {
            margin: 15px 0;
            background: #f8fdf9;
            border: 1px solid #d4f0e0;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 88, 38, 0.08);
        }

        .price-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 16px;
            font-weight: 600;
            color: #005826;
        }

        .price-card-header i {
            font-size: 20px;
        }

        .hospital-item {
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .hospital-item:hover {
            border-color: #005826;
            box-shadow: 0 4px 12px rgba(0, 88, 38, 0.15);
            transform: translateY(-2px);
        }

        .hospital-item:last-child {
            margin-bottom: 0;
        }

        .hospital-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .hospital-name-section {
            flex: 1;
        }

        .hospital-name {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .hospital-type-badge {
            display: inline-block;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            margin-right: 6px;
        }

        .hospital-type-badge.public {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .hospital-type-badge.private {
            background: #fff3e0;
            color: #e65100;
        }

        .hospital-rating {
            color: #ff9800;
            font-size: 13px;
            font-weight: 500;
        }

        .hospital-price-section {
            text-align: right;
        }

        .hospital-price {
            font-size: 24px;
            font-weight: 700;
            color: #005826;
            line-height: 1;
        }

        .hospital-price-label {
            font-size: 12px;
            color: #999;
            margin-top: 2px;
        }

        .hospital-details {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .hospital-detail-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .hospital-detail-item i {
            color: #005826;
            font-size: 14px;
        }

        .hospital-actions {
            display: flex;
            gap: 8px;
        }

        .hospital-btn {
            flex: 1;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .hospital-btn-primary {
            background: #005826;
            color: white;
        }

        .hospital-btn-primary:hover {
            background: #00722f;
        }

        .hospital-btn-primary:disabled {
            background: #d9d9d9;
            color: #999;
            cursor: not-allowed;
        }

        .hospital-btn-secondary {
            background: white;
            color: #005826;
            border: 1px solid #005826;
        }

        .hospital-btn-secondary:hover {
            background: #f0f9f4;
        }

        .price-card-footer {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed #e0e0e0;
            font-size: 12px;
            color: #999;
            text-align: center;
        }
    </style>
</head>

<body>
    <!-- ä¾§è¾¹æ é®ç½© -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">å¯¹è¯å†å²</div>
            <button class="sidebar-close" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="sidebar-content">
            <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fas fa-plus"></i>
                <span>æ–°å¯¹è¯</span>
            </button>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="chat-container">
        <!-- å¤´éƒ¨ -->
        <div class="chat-header">
            <div class="header-left">
                <button class="menu-btn" onclick="toggleSidebar()" title="å¯¹è¯å†å²">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="header-title">
                    <h1><img src="/static/images/owl-mascot.png" alt="é€¸ä»™" style="width: 28px; height: 28px; vertical-align: middle; margin-right: 8px; border-radius: 50%;"> é€¸ä»™æ™ºæ£€</h1>
                </div>
            </div>
        </div>

        <!-- èŠå¤©æ¶ˆæ¯åŒº -->
        <div class="chat-messages" id="chatMessages">
            <!-- åˆå§‹æ¬¢è¿ç•Œé¢ -->
            <div class="initial-view" id="initialView">
                <div class="hero-section">
                    <div class="doctor-avatar">
                        <img src="/static/images/owl-mascot.png" alt="é€¸ä»™"
                            onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\'width:200px;height:200px;border-radius:50%;background:#f0f9f4;display:flex;align-items:center;justify-content:center\'><i class=\'fas fa-user-md\' style=\'font-size:90px;color:#005826\'></i></div>'">
                    </div>
                    <div class="hero-title">æˆ‘æ˜¯å°é¹°</div>
                    <div class="hero-subtitle">ä½ çš„AIå¥åº·ä¸“å®¶</div>
                </div>

                <!-- å¿«æ·æŒ‰é’® -->
                <div class="quick-actions">
                    <button class="quick-action-btn" id="detectionBtn" onclick="handleDetectionRecommendation()">
                        <i class="fas fa-clipboard-list"></i>
                        <span>æ£€æµ‹æ¨è</span>
                    </button>
                    <button class="quick-action-btn" id="reportBtn" onclick="handleReportInterpretation()">
                        <i class="fas fa-file-medical-alt"></i>
                        <span>æŠ¥å‘Šè§£è¯»</span>
                    </button>
                    <button class="quick-action-btn" id="diseaseBtn" onclick="handleDiseaseExplore()">
                        <i class="fas fa-book-medical"></i>
                        <span>äº†è§£ç–¾ç—…</span>
                    </button>
                </div>
            </div>

            <!-- æ¶ˆæ¯å®¹å™¨ -->
            <div class="messages-container" id="messagesContainer"></div>
        </div>

        <!-- ç–¾ç—…é€‰æ‹©æ¨¡æ€çª—å£ -->
        <div class="modal-overlay" id="diseaseModal" onclick="closeDiseaseModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-title">è¯·é€‰æ‹©æ‚¨å…³æ³¨çš„èº«ä½“åŒºåŸŸ</div>
                <div class="disease-grid">
                    <div class="disease-card" onclick="selectDiseaseCategory('å¤´é¢ä¸æ„Ÿå®˜')">
                        <div class="disease-card-icon">ğŸ§ </div>
                        <div class="disease-card-title">å¤´é¢ä¸æ„Ÿå®˜</div>
                    </div>
                    <div class="disease-card" onclick="selectDiseaseCategory('å‘¼å¸ä¸å¿ƒè·³')">
                        <div class="disease-card-icon">ğŸ«</div>
                        <div class="disease-card-title">å‘¼å¸ä¸å¿ƒè·³</div>
                    </div>
                    <div class="disease-card" onclick="selectDiseaseCategory('æ¶ˆåŒ–ä¸æ’æ³„')">
                        <div class="disease-card-icon">ğŸ¥£</div>
                        <div class="disease-card-title">æ¶ˆåŒ–ä¸æ’æ³„</div>
                    </div>
                    <div class="disease-card" onclick="selectDiseaseCategory('ç­‹éª¨ä¸è¿åŠ¨')">
                        <div class="disease-card-icon">ğŸ¦´</div>
                        <div class="disease-card-title">ç­‹éª¨ä¸è¿åŠ¨</div>
                    </div>
                    <div class="disease-card" onclick="selectDiseaseCategory('çš®è‚¤ä¸å¤–å½¢')">
                        <div class="disease-card-icon">ğŸ§¬</div>
                        <div class="disease-card-title">çš®è‚¤ä¸å¤–å½¢</div>
                    </div>
                    <div class="disease-card" onclick="selectDiseaseCategory('æ•´ä½“çŠ¶æ€ä¸ç¡çœ ')">
                        <div class="disease-card-icon">ğŸ‘¤</div>
                        <div class="disease-card-title">æ•´ä½“çŠ¶æ€ä¸ç¡çœ </div>
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰è¾“å…¥åŒº -->
                <div class="modal-custom-input">
                    <div class="modal-input-label">æˆ–è€…ç›´æ¥æè¿°æ‚¨çš„é—®é¢˜ï¼š</div>
                    <div class="modal-input-wrapper">
                        <input type="text" class="modal-input" id="customSymptomInput" placeholder="ä¾‹å¦‚ï¼šæœ€è¿‘æ€»æ˜¯å¤´æ™•ã€èƒƒç—›ä¸€ä¸ªæ˜ŸæœŸäº†..." onkeypress="handleCustomInputEnter(event)">
                        <button class="modal-submit-btn" onclick="submitCustomSymptom()">æäº¤</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç—‡çŠ¶è¡¨å•æ¨¡æ€çª—å£ -->
        <div class="modal-overlay" id="symptomFormModal" onclick="closeSymptomFormModal(event)">
            <div class="modal-content symptom-form-modal" onclick="event.stopPropagation()">
                <div class="modal-title" id="symptomFormTitle">è¯·é€‰æ‹©æ‚¨çš„ç—‡çŠ¶</div>
                <div id="symptomFormContent">
                    <!-- åŠ¨æ€ç”Ÿæˆçš„è¡¨å•å†…å®¹ -->
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="chat-input-area">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea id="messageInput" placeholder="æè¿°æ‚¨çš„å¥åº·é—®é¢˜..." rows="1" onkeydown="handleKeyPress(event)"
                        oninput="autoResize(this)"></textarea>

                    <button class="input-btn" onclick="document.getElementById('imageInput').click()" title="ä¸Šä¼ å›¾ç‰‡">
                        <i class="fas fa-image"></i>
                    </button>
                    <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">

                    <button class="input-btn" id="voiceBtn" onclick="toggleVoiceRecording()" title="è¯­éŸ³è¾“å…¥">
                        <i class="fas fa-microphone"></i>
                    </button>

                    <button class="send-btn" onclick="sendMessage()">
                        å‘é€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isRecording = false;
        let chatHistory = [];
        let currentChatId = null;

        // ç—‡çŠ¶é…ç½®æ•°æ®ï¼ˆé…ç½®é©±åŠ¨ï¼‰
        const SYMPTOM_CONFIG = {
            'å¤´é¢ä¸æ„Ÿå®˜': {
                symptoms: ['å¤´ç—›', 'å¤´æ™•/çœ©æ™•', 'è§†åŠ›æ¨¡ç³Š', 'è€³é¸£/å¬åŠ›ä¸‹é™', 'é¼»å¡/æµæ¶•', 'ç‰™ç—›/å£è…”æºƒç–¡', 'é¢éƒ¨éº»æœ¨'],
                duration: ['çªå‘(å‡ åˆ†é’Ÿ-å‡ å°æ—¶)', 'æ€¥æ€§(å‡ å¤©)', 'æ…¢æ€§(æ•°å‘¨ä»¥ä¸Š)', 'é—´æ­‡æ€§å‘ä½œ'],
                triggers: ['ç†¬å¤œ/åŠ³ç´¯', 'æƒ…ç»ªæ¿€åŠ¨', 'å—å¯’/å¹é£', 'é•¿æ—¶é—´çœ‹å±å¹•', 'å¤´éƒ¨å¤–ä¼¤å'],
                history: ['é«˜è¡€å‹', 'ç³–å°¿ç—…', 'å¿ƒè„ç—…', 'æ‰‹æœ¯å²', 'è¯ç‰©è¿‡æ•å²', 'å¸çƒŸ/é¥®é…’']
            },
            'å‘¼å¸ä¸å¿ƒè·³': {
                symptoms: ['å‘¼å¸å›°éš¾', 'æ°”çŸ­', 'èƒ¸é—·/èƒ¸ç—›', 'å‰§çƒˆå’³å—½', 'å’³ç—°ï¼ˆç™½ç—°/é»„ç—°/è¡€ç—°ï¼‰', 'å¿ƒæ‚¸/å¿ƒæ…Œ'],
                duration: ['çªå‘(å‡ åˆ†é’Ÿ-å‡ å°æ—¶)', 'æ€¥æ€§(å‡ å¤©)', 'æ…¢æ€§(æ•°å‘¨ä»¥ä¸Š)', 'é—´æ­‡æ€§å‘ä½œ'],
                triggers: ['è¿åŠ¨å', 'å¤œé—´/å¹³å§æ—¶', 'å¸å…¥å†·ç©ºæ°”/ç²‰å°˜', 'æƒ…ç»ªå˜åŒ–æ—¶'],
                history: ['é«˜è¡€å‹', 'ç³–å°¿ç—…', 'å¿ƒè„ç—…', 'æ‰‹æœ¯å²', 'è¯ç‰©è¿‡æ•å²', 'å¸çƒŸ/é¥®é…’']
            },
            'æ¶ˆåŒ–ä¸æ’æ³„': {
                symptoms: ['ä¸Šè…¹ç—›ï¼ˆèƒƒç—›ï¼‰', 'ä¸‹è…¹ç—›', 'è…¹èƒ€/å—³æ°”', 'åé…¸/çƒ§å¿ƒ', 'æ¶å¿ƒ/å‘•å', 'è…¹æ³»', 'ä¾¿ç§˜', 'ä¾¿è¡€/é»‘ä¾¿', 'å°¿é¢‘/å°¿æ€¥/å°¿ç—›'],
                duration: ['çªå‘(å‡ åˆ†é’Ÿ-å‡ å°æ—¶)', 'æ€¥æ€§(å‡ å¤©)', 'æ…¢æ€§(æ•°å‘¨ä»¥ä¸Š)', 'é—´æ­‡æ€§å‘ä½œ'],
                triggers: ['è¿›é£Ÿç”Ÿå†·è¾›è¾£', 'é¥®é…’å', 'ç©ºè…¹æ—¶', 'é¤åç«‹å³å‡ºç°', 'å¤œé—´'],
                history: ['é«˜è¡€å‹', 'ç³–å°¿ç—…', 'å¿ƒè„ç—…', 'æ‰‹æœ¯å²', 'è¯ç‰©è¿‡æ•å²', 'å¸çƒŸ/é¥®é…’']
            },
            'ç­‹éª¨ä¸è¿åŠ¨': {
                symptoms: ['å…³èŠ‚ç–¼ç—›', 'å…³èŠ‚è‚¿èƒ€', 'è‚Œè‚‰é…¸ç—›', 'è…°èƒŒç—›', 'æ´»åŠ¨å—é™', 'æ™¨èµ·åƒµç¡¬', 'è‚¢ä½“éº»æœ¨/æ— åŠ›'],
                duration: ['å¤–ä¼¤åç«‹å³', 'é•¿æœŸæ…¢æ€§ç–¼ç—›', 'é˜´é›¨å¤©åŠ é‡'],
                position: ['é¢ˆæ¤/è‚©éƒ¨', 'è…°æ¤', 'è†å…³èŠ‚', 'æ‰‹è…•/è„šè¸'],
                history: ['é«˜è¡€å‹', 'ç³–å°¿ç—…', 'å¿ƒè„ç—…', 'æ‰‹æœ¯å²', 'è¯ç‰©è¿‡æ•å²', 'å¸çƒŸ/é¥®é…’']
            },
            'çš®è‚¤ä¸å¤–å½¢': {
                symptoms: ['çš®ç–¹/çº¢æ–‘', 'ç˜™ç—’', 'èµ·æ°´æ³¡', 'çš®è‚¤è‚¿å—/ç»“èŠ‚', 'çš®è‚¤é¢œè‰²æ”¹å˜', 'è„±å‘', 'å¼‚å¸¸å‡ºè¡€/æ·¤æ–‘'],
                duration: ['çªå‘(å‡ åˆ†é’Ÿ-å‡ å°æ—¶)', 'æ€¥æ€§(å‡ å¤©)', 'æ…¢æ€§(æ•°å‘¨ä»¥ä¸Š)', 'é—´æ­‡æ€§å‘ä½œ'],
                triggers: ['æ¥è§¦è¿‡æ•åŸ', 'æ¢å­£æ—¶', 'æš´æ™’å', 'è¿›é£Ÿæµ·é²œå'],
                history: ['é«˜è¡€å‹', 'ç³–å°¿ç—…', 'å¿ƒè„ç—…', 'æ‰‹æœ¯å²', 'è¯ç‰©è¿‡æ•å²', 'å¸çƒŸ/é¥®é…’']
            },
            'æ•´ä½“çŠ¶æ€ä¸ç¡çœ ': {
                symptoms: ['å‘çƒ­ï¼ˆä½çƒ­/é«˜çƒ­ï¼‰', 'ç•å¯’', 'ä¸æ˜åŸå› ä½“é‡ä¸‹é™', 'èº«ä½“æµ®è‚¿', 'æåº¦ä¹åŠ›', 'å¤±çœ /å¤šæ¢¦', 'æƒ…ç»ªä½è½/ç„¦è™‘'],
                duration: ['çªå‘(å‡ åˆ†é’Ÿ-å‡ å°æ—¶)', 'æ€¥æ€§(å‡ å¤©)', 'æ…¢æ€§(æ•°å‘¨ä»¥ä¸Š)', 'é—´æ­‡æ€§å‘ä½œ'],
                triggers: ['ç†¬å¤œ/åŠ³ç´¯', 'æƒ…ç»ªæ¿€åŠ¨', 'ç¯å¢ƒå˜åŒ–', 'å­£èŠ‚å˜åŒ–'],
                history: ['é«˜è¡€å‹', 'ç³–å°¿ç—…', 'å¿ƒè„ç—…', 'æ‰‹æœ¯å²', 'è¯ç‰©è¿‡æ•å²', 'å¸çƒŸ/é¥®é…’']
            }
        };

        // é€šç”¨è¡¨å•æ¸²æŸ“å‡½æ•°
        function renderSymptomForm(categoryName) {
            const config = SYMPTOM_CONFIG[categoryName];
            if (!config) return;

            const formContent = document.getElementById('symptomFormContent');
            document.getElementById('symptomFormTitle').textContent = `${categoryName} - ç—‡çŠ¶è¯„ä¼°è¡¨`;

            let html = '<form id="symptomForm">';

            // ç—‡çŠ¶é€‰æ‹©ï¼ˆå¤šé€‰ï¼‰
            html += '<div class="form-section">';
            html += '<div class="form-section-title">ç—‡çŠ¶è¡¨ç°ï¼ˆå¯å¤šé€‰ï¼‰</div>';
            html += '<div class="form-options">';
            config.symptoms.forEach((symptom, index) => {
                html += `
                    <div class="form-option">
                        <input type="checkbox" id="symptom_${index}" name="symptoms" value="${symptom}">
                        <label for="symptom_${index}">${symptom}</label>
                    </div>
                `;
            });
            html += '</div></div>';

            // æŒç»­æ—¶é•¿ï¼ˆå•é€‰ï¼‰
            html += '<div class="form-section">';
            html += '<div class="form-section-title">æŒç»­æ—¶é•¿ï¼ˆå•é€‰ï¼‰</div>';
            html += '<div class="form-options">';
            config.duration.forEach((dur, index) => {
                html += `
                    <div class="form-option">
                        <input type="radio" id="duration_${index}" name="duration" value="${dur}">
                        <label for="duration_${index}">${dur}</label>
                    </div>
                `;
            });
            html += '</div></div>';

            // è¯±å› /ä½ç½®ï¼ˆå¤šé€‰ï¼‰
            if (config.triggers) {
                html += '<div class="form-section">';
                html += '<div class="form-section-title">è¯±å‘å› ç´ ï¼ˆå¯å¤šé€‰ï¼‰</div>';
                html += '<div class="form-options">';
                config.triggers.forEach((trigger, index) => {
                    html += `
                        <div class="form-option">
                            <input type="checkbox" id="trigger_${index}" name="triggers" value="${trigger}">
                            <label for="trigger_${index}">${trigger}</label>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            if (config.position) {
                html += '<div class="form-section">';
                html += '<div class="form-section-title">ç–¼ç—›ä½ç½®ï¼ˆå¯å¤šé€‰ï¼‰</div>';
                html += '<div class="form-options">';
                config.position.forEach((pos, index) => {
                    html += `
                        <div class="form-option">
                            <input type="checkbox" id="position_${index}" name="position" value="${pos}">
                            <label for="position_${index}">${pos}</label>
                        </div>
                    `;
                });
                html += '</div></div>';
            }

            // æ—¢å¾€å²ï¼ˆå¤šé€‰ï¼‰
            html += '<div class="form-section">';
            html += '<div class="form-section-title">æ—¢å¾€ç—…å²ï¼ˆå¯å¤šé€‰ï¼‰</div>';
            html += '<div class="form-options">';
            config.history.forEach((hist, index) => {
                html += `
                    <div class="form-option">
                        <input type="checkbox" id="history_${index}" name="history" value="${hist}">
                        <label for="history_${index}">${hist}</label>
                    </div>
                `;
            });
            html += '</div></div>';

            html += `<button type="button" class="form-submit-btn" onclick="submitSymptomForm('${categoryName}')">æäº¤è¯„ä¼°</button>`;
            html += '</form>';

            formContent.innerHTML = html;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function () {
            loadHistory();
            
            // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
            initSpeechRecognition();
            
            // æ·»åŠ ç²˜è´´äº‹ä»¶ç›‘å¬
            document.addEventListener('paste', handlePaste);
        });

        // å¤„ç†ç²˜è´´äº‹ä»¶
        function handlePaste(event) {
            const items = event.clipboardData.items;
            
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    event.preventDefault();
                    const file = items[i].getAsFile();
                    
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const initialView = document.getElementById('initialView');
                        if (initialView) {
                            initialView.classList.add('hidden');
                        }

                        const imageBase64 = e.target.result;
                        addMessage('user', 'æˆ‘ç²˜è´´äº†ä¸€å¼ å›¾ç‰‡', imageBase64);

                        setTimeout(async () => {
                            showTypingIndicator();
                            const response = await generateResponse('è¯·å¸®æˆ‘åˆ†æè¿™å¼ ä½“æ£€æŠ¥å‘Šï¼Œé‡ç‚¹å…³æ³¨å¼‚å¸¸æŒ‡æ ‡å’Œå¥åº·é£é™©ã€‚', imageBase64);
                            hideTypingIndicator();
                            addMessage('assistant', response);
                        }, 300);
                    };
                    reader.readAsDataURL(file);
                    break;
                }
            }
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const saved = localStorage.getItem('chatHistory');
            if (saved) {
                chatHistory = JSON.parse(saved);
                renderHistory();
            }
        }

        // æ¸²æŸ“å†å²è®°å½•åˆ—è¡¨
        function renderHistory() {
            const historyList = document.getElementById('historyList');

            if (chatHistory.length === 0) {
                historyList.innerHTML = `
                    <div class="empty-history">
                        <i class="fas fa-comments"></i>
                        <p>æš‚æ— å¯¹è¯è®°å½•</p>
                    </div>
                `;
                return;
            }

            // æŒ‰æ—¥æœŸåˆ†ç»„
            const today = [];
            const yesterday = [];
            const older = [];
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterdayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);

            chatHistory.forEach(chat => {
                const chatDate = new Date(chat.timestamp);
                if (chatDate >= todayStart) {
                    today.push(chat);
                } else if (chatDate >= yesterdayStart) {
                    yesterday.push(chat);
                } else {
                    older.push(chat);
                }
            });

            let html = '';

            if (today.length > 0) {
                html += '<div class="history-section"><div class="history-section-title">ä»Šå¤©</div>';
                today.forEach(chat => html += renderHistoryItem(chat));
                html += '</div>';
            }

            if (yesterday.length > 0) {
                html += '<div class="history-section"><div class="history-section-title">æ˜¨å¤©</div>';
                yesterday.forEach(chat => html += renderHistoryItem(chat));
                html += '</div>';
            }

            if (older.length > 0) {
                html += '<div class="history-section"><div class="history-section-title">æ›´æ—©</div>';
                older.forEach(chat => html += renderHistoryItem(chat));
                html += '</div>';
            }

            historyList.innerHTML = html;
        }

        // æ¸²æŸ“å•ä¸ªå†å²è®°å½•é¡¹
        function renderHistoryItem(chat) {
            const isActive = chat.id === currentChatId ? 'active' : '';
            const time = new Date(chat.timestamp).toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit'
            });

            return `
                <div class="history-item ${isActive}" onclick="loadChat('${chat.id}')">
                    <div class="history-item-icon">
                        <i class="fas fa-comment-dots"></i>
                    </div>
                    <div class="history-item-content">
                        <div class="history-item-title">${chat.title}</div>
                        <div class="history-item-time">${time}</div>
                    </div>
                    <div class="history-item-delete" onclick="event.stopPropagation(); deleteChat('${chat.id}')" title="åˆ é™¤å¯¹è¯">
                        <i class="fas fa-trash-alt"></i>
                    </div>
                </div>
            `;
        }

        // åˆ é™¤å¯¹è¯
        function deleteChat(chatId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯¹è¯è®°å½•å—ï¼Ÿ')) {
                return;
            }

            // ä»å†å²è®°å½•ä¸­ç§»é™¤
            chatHistory = chatHistory.filter(chat => chat.id !== chatId);
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰å¯¹è¯ï¼Œæ¸…ç©ºèŠå¤©åŒºåŸŸå¹¶å¼€å§‹æ–°å¯¹è¯
            if (chatId === currentChatId) {
                startNewChat();
            }

            // é‡æ–°æ¸²æŸ“å†å²è®°å½•
            renderHistory();
        }

        // ä¿å­˜å½“å‰å¯¹è¯
        function saveCurrentChat() {
            const messagesContainer = document.getElementById('messagesContainer');
            const messages = messagesContainer.querySelectorAll('.message');

            if (messages.length === 0) return;

            if (!currentChatId) {
                currentChatId = 'chat_' + Date.now();
                const firstMessage = messagesContainer.querySelector('.message.user .message-content div:first-child');
                const title = firstMessage ? firstMessage.textContent.substring(0, 30) : 'æ–°å¯¹è¯';

                chatHistory.unshift({
                    id: currentChatId,
                    title: title,
                    timestamp: Date.now(),
                    messages: []
                });
            }

            // æ›´æ–°å½“å‰å¯¹è¯çš„æ¶ˆæ¯
            const currentChat = chatHistory.find(chat => chat.id === currentChatId);
            if (currentChat) {
                const messageArray = Array.from(messages).map(msg => {
                    const type = msg.classList.contains('user') ? 'user' : 'assistant';
                    const contentDiv = msg.querySelector('.message-content div:first-child');
                    const content = contentDiv ? contentDiv.textContent : '';
                    return { type, content };
                });
                currentChat.messages = messageArray;
            }

            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            renderHistory();
        }

        // åŠ è½½æŒ‡å®šå¯¹è¯
        function loadChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;

            currentChatId = chatId;
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';

            const initialView = document.getElementById('initialView');
            if (initialView) {
                initialView.classList.add('hidden');
            }

            chat.messages.forEach(msg => {
                addMessageToDOM(msg.type, msg.content);
            });

            toggleSidebar();
            renderHistory();
        }

        // å¼€å§‹æ–°å¯¹è¯
        function startNewChat() {
            currentChatId = null;
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';

            const initialView = document.getElementById('initialView');
            if (initialView) {
                initialView.classList.remove('hidden');
            }

            toggleSidebar();
            renderHistory();
        }

        // åˆ‡æ¢ä¾§è¾¹æ 
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        // å¤„ç†æ£€æµ‹æ¨èæŒ‰é’®
        function handleDetectionRecommendation() {
            const initialView = document.getElementById('initialView');
            if (initialView) {
                initialView.classList.add('hidden');
            }

            // æ¿€æ´»æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('detectionBtn').classList.add('active');

            // AIè‡ªåŠ¨å›å¤
            addMessage('assistant', 'æ”¶åˆ°ï¼è¯·å‘Šè¯‰æˆ‘æ‚¨çš„å…·ä½“éœ€æ±‚ï¼š');

            // æ·»åŠ å¿«é€Ÿé€‰é¡¹
            setTimeout(() => {
                const messagesContainer = document.getElementById('messagesContainer');
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'quick-options';
                optionsDiv.innerHTML = `
                    <button class="quick-option-chip" onclick="handleDetectionOption('èº«ä½“ä¸é€‚')">
                        ğŸ©º èº«ä½“ä¸é€‚
                    </button>
                    <button class="quick-option-chip" onclick="handleDetectionOption('å®šæœŸä½“æ£€')">
                        ğŸ“‹ å®šæœŸä½“æ£€
                    </button>
                `;
                messagesContainer.appendChild(optionsDiv);

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 300);
        }

        // å¤„ç†æ£€æµ‹é€‰é¡¹ç‚¹å‡»
        async function handleDetectionOption(option) {
            // ç§»é™¤å¿«é€Ÿé€‰é¡¹
            document.querySelectorAll('.quick-options').forEach(el => el.remove());

            if (option === 'èº«ä½“ä¸é€‚') {
                // æ˜¾ç¤ºç–¾ç—…åˆ†ç±»æ¨¡æ€çª—å£ï¼ˆä¸"äº†è§£ç–¾ç—…"å…±ç”¨ï¼‰
                document.getElementById('diseaseModal').classList.add('show');
            } else {
                // å®šæœŸä½“æ£€é€‰é¡¹
                addMessage('user', option);

                setTimeout(async () => {
                    showTypingIndicator();
                    const response = await generateResponse('æˆ‘æƒ³åšå®šæœŸä½“æ£€ï¼Œè¯·é—®æ˜¯å…¨èº«ä½“æ£€è¿˜æ˜¯é’ˆå¯¹ç‰¹å®šç›®æ ‡ï¼ˆå¦‚å…¥èŒã€å¤‡å­•ï¼‰çš„æ£€æŸ¥ï¼Ÿ');
                    hideTypingIndicator();
                    addMessage('assistant', response);
                }, 300);
            }
        }

        // å¤„ç†æŠ¥å‘Šè§£è¯»æŒ‰é’®
        function handleReportInterpretation() {
            const initialView = document.getElementById('initialView');
            if (initialView) {
                initialView.classList.add('hidden');
            }

            // æ¿€æ´»æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('reportBtn').classList.add('active');

            // AIå‘é€å¼•å¯¼è¯­
            addMessage('assistant', 'è¯·ä¸Šä¼ æ‚¨çš„æ£€éªŒæŠ¥å‘Šå›¾ç‰‡æˆ–æ–‡ä»¶ï¼ˆæ”¯æŒ JPG, PNG, PDFï¼‰ã€‚å¦‚æœæ˜¯æ‹ç…§ï¼Œè¯·å°½é‡ä¿è¯æ–‡å­—æ¸…æ™°ã€‚');

            // è‡ªåŠ¨è§¦å‘æ–‡ä»¶ä¸Šä¼ 
            setTimeout(() => {
                document.getElementById('imageInput').click();
            }, 500);
        }

        // å¤„ç†äº†è§£ç–¾ç—…æŒ‰é’®
        function handleDiseaseExplore() {
            // æ¿€æ´»æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('diseaseBtn').classList.add('active');

            // æ˜¾ç¤ºæ¨¡æ€çª—å£
            document.getElementById('diseaseModal').classList.add('show');
        }

        // å…³é—­ç–¾ç—…æ¨¡æ€çª—å£
        function closeDiseaseModal(event) {
            if (event.target.id === 'diseaseModal') {
                document.getElementById('diseaseModal').classList.remove('show');
                document.getElementById('diseaseBtn').classList.remove('active');
            }
        }

        // é€‰æ‹©ç–¾ç—…åˆ†ç±»
        function selectDiseaseCategory(category) {
            // å…³é—­åˆ†ç±»é€‰æ‹©æ¨¡æ€çª—å£
            document.getElementById('diseaseModal').classList.remove('show');
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('customSymptomInput').value = '';

            // æ¸²æŸ“å¹¶æ˜¾ç¤ºç—‡çŠ¶è¡¨å•
            renderSymptomForm(category);
            document.getElementById('symptomFormModal').classList.add('show');
        }

        // å…³é—­ç—‡çŠ¶è¡¨å•æ¨¡æ€çª—å£
        function closeSymptomFormModal(event) {
            if (event.target.id === 'symptomFormModal') {
                document.getElementById('symptomFormModal').classList.remove('show');
            }
        }

        // æäº¤ç—‡çŠ¶è¡¨å•
        async function submitSymptomForm(categoryName) {
            const form = document.getElementById('symptomForm');
            
            // æ”¶é›†é€‰ä¸­çš„ç—‡çŠ¶
            const symptoms = Array.from(form.querySelectorAll('input[name="symptoms"]:checked'))
                .map(input => input.value);
            
            // æ”¶é›†æŒç»­æ—¶é•¿
            const duration = form.querySelector('input[name="duration"]:checked')?.value || 'æœªé€‰æ‹©';
            
            // æ”¶é›†è¯±å› 
            const triggers = Array.from(form.querySelectorAll('input[name="triggers"]:checked'))
                .map(input => input.value);
            
            // æ”¶é›†ä½ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
            const position = Array.from(form.querySelectorAll('input[name="position"]:checked'))
                .map(input => input.value);
            
            // æ”¶é›†æ—¢å¾€å²
            const history = Array.from(form.querySelectorAll('input[name="history"]:checked'))
                .map(input => input.value);

            // éªŒè¯æ˜¯å¦è‡³å°‘é€‰æ‹©äº†ä¸€ä¸ªç—‡çŠ¶
            if (symptoms.length === 0) {
                alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç—‡çŠ¶');
                return;
            }

            // æ„å»ºæè¿°æ–‡å­—
            let description = `ç”¨æˆ·ä¸»è¯‰${categoryName}ä¸é€‚ï¼Œå…·ä½“ç—‡çŠ¶ä¸ºï¼š${symptoms.join('ã€')}ã€‚`;
            description += `æŒç»­æ—¶é•¿ï¼š${duration}ã€‚`;
            
            if (triggers.length > 0) {
                description += `è¯±å‘å› ç´ ï¼š${triggers.join('ã€')}ã€‚`;
            }
            
            if (position.length > 0) {
                description += `ç–¼ç—›ä½ç½®ï¼š${position.join('ã€')}ã€‚`;
            }
            
            if (history.length > 0) {
                description += `æ—¢å¾€ç—…å²ï¼š${history.join('ã€')}ã€‚`;
            }

            // å…³é—­æ¨¡æ€çª—å£
            document.getElementById('symptomFormModal').classList.remove('show');

            const initialView = document.getElementById('initialView');
            if (initialView) {
                initialView.classList.add('hidden');
            }

            // å‘é€ç”¨æˆ·æè¿°
            addMessage('user', description);

            // AIå›å¤
            setTimeout(async () => {
                showTypingIndicator();
                const response = await generateResponse(description + ' è¯·æ ¹æ®è¿™äº›ç—‡çŠ¶è¿›è¡Œä¸“ä¸šåˆ†æå’Œå»ºè®®ã€‚');
                hideTypingIndicator();
                addMessage('assistant', response);
            }, 300);
        }

        // æäº¤è‡ªå®šä¹‰ç—‡çŠ¶
        async function submitCustomSymptom() {
            const input = document.getElementById('customSymptomInput');
            const symptom = input.value.trim();
            
            if (!symptom) {
                alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜æè¿°');
                return;
            }

            // å…³é—­æ¨¡æ€çª—å£
            document.getElementById('diseaseModal').classList.remove('show');
            input.value = '';

            const initialView = document.getElementById('initialView');
            if (initialView) {
                initialView.classList.add('hidden');
            }

            // å‘é€ç”¨æˆ·è¾“å…¥
            addMessage('user', symptom);

            // AIå¼€å§‹é—®è¯Š
            setTimeout(async () => {
                showTypingIndicator();
                const response = await generateResponse(symptom);
                hideTypingIndicator();
                addMessage('assistant', response);
            }, 300);
        }

        // å¤„ç†å›è½¦é”®æäº¤
        function handleCustomInputEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                submitCustomSymptom();
            }
        }

        // å¿«æ·æŒ‰é’®å‘é€æ¶ˆæ¯
        async function sendQuickMessage(text) {
            const initialView = document.getElementById('initialView');
            if (initialView) {
                initialView.classList.add('hidden');
            }

            addMessage('user', text);

            // è°ƒç”¨AIå›å¤
            setTimeout(async () => {
                showTypingIndicator();
                const response = await generateResponse(text);
                hideTypingIndicator();
                addMessage('assistant', response);
            }, 300);
        }

        // æ·»åŠ æ¶ˆæ¯
        function addMessage(type, content, imageUrl = null) {
            addMessageToDOM(type, content, imageUrl);
            saveCurrentChat();
        }

        // æ£€æŸ¥é¡¹ç›®å…³é”®è¯æ˜ å°„
        const CHECK_ITEM_KEYWORDS = {
            "è¡€å¸¸è§„": ["è¡€å¸¸è§„", "è¡€æ¶²æ£€æŸ¥", "è¡€ç»†èƒ"],
            "èƒ¸éƒ¨CT": ["èƒ¸éƒ¨CT", "èƒ¸éƒ¨ CT", "èƒ¸CT", "CTèƒ¸éƒ¨", "è‚ºéƒ¨CT"],
            "å¿ƒç”µå›¾": ["å¿ƒç”µå›¾", "ECG", "å¿ƒç”µ"],
            "æ ¸ç£å…±æŒ¯": ["æ ¸ç£", "æ ¸ç£å…±æŒ¯", "MRI", "ç£å…±æŒ¯"],
            "è…¹éƒ¨Bè¶…": ["è…¹éƒ¨Bè¶…", "è…¹éƒ¨è¶…å£°", "Bè¶…", "å½©è¶…"],
            "è‚åŠŸèƒ½": ["è‚åŠŸèƒ½", "è‚åŠŸ", "è½¬æ°¨é…¶"]
        };

        // è¯†åˆ«AIå›å¤ä¸­çš„æ£€æŸ¥é¡¹ç›®
        function detectCheckItems(aiResponse) {
            const detectedItems = [];
            
            for (const [itemName, keywords] of Object.entries(CHECK_ITEM_KEYWORDS)) {
                for (const keyword of keywords) {
                    if (aiResponse.includes(keyword)) {
                        if (!detectedItems.includes(itemName)) {
                            detectedItems.push(itemName);
                        }
                        break;
                    }
                }
            }
            
            return detectedItems;
        }

        // æ¸²æŸ“ä»·æ ¼å¯¹æ¯”å¡ç‰‡
        async function renderPriceCard(checkItem, parentElement) {
            try {
                const response = await fetch('/api/hospital_prices', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ checkItem: checkItem })
                });

                const data = await response.json();
                
                if (data.success && data.hospitals) {
                    const cardContainer = document.createElement('div');
                    cardContainer.className = 'price-card-container';
                    
                    let cardHTML = `
                        <div class="price-card-header">
                            <i class="fas fa-search-dollar"></i>
                            <span>${data.checkItem} å‘¨è¾¹ä»·æ ¼å‚è€ƒ</span>
                        </div>
                    `;
                    
                    data.hospitals.forEach(hospital => {
                        const isAvailable = hospital.booking_status === 'å¯é¢„çº¦';
                        cardHTML += `
                            <div class="hospital-item">
                                <div class="hospital-header">
                                    <div class="hospital-name-section">
                                        <div class="hospital-name">
                                            ${hospital.name}
                                            <span class="hospital-rating">
                                                <i class="fas fa-star"></i> ${hospital.rating}
                                            </span>
                                        </div>
                                        <div>
                                            <span class="hospital-type-badge ${hospital.type}">${hospital.type === 'public' ? 'å…¬ç«‹' : 'ç§ç«‹'}</span>
                                        </div>
                                    </div>
                                    <div class="hospital-price-section">
                                        <div class="hospital-price">Â¥${hospital.price}</div>
                                        <div class="hospital-price-label">é¢„ä¼°ä»·æ ¼</div>
                                    </div>
                                </div>
                                <div class="hospital-details">
                                    <div class="hospital-detail-item">
                                        <i class="fas fa-map-marker-alt"></i>
                                        <span>${hospital.distance}</span>
                                    </div>
                                    <div class="hospital-detail-item">
                                        <i class="fas fa-building"></i>
                                        <span>${hospital.department}</span>
                                    </div>
                                    <div class="hospital-detail-item">
                                        <i class="fas fa-clock"></i>
                                        <span>${hospital.wait_time}</span>
                                    </div>
                                </div>
                                <div class="hospital-actions">
                                    <button class="hospital-btn hospital-btn-primary" 
                                            ${!isAvailable ? 'disabled' : ''}
                                            onclick="bookHospital('${hospital.name}', '${data.checkItem}')">
                                        ${isAvailable ? '<i class="fas fa-calendar-check"></i> ç«‹å³é¢„çº¦' : '<i class="fas fa-ban"></i> é¢„çº¦å·²æ»¡'}
                                    </button>
                                    <button class="hospital-btn hospital-btn-secondary" 
                                            onclick="viewHospitalDetails('${hospital.name}')">
                                        <i class="fas fa-info-circle"></i> è¯¦æƒ…
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    cardHTML += `
                        <div class="price-card-footer">
                            <i class="fas fa-info-circle"></i> 
                            ä»·æ ¼ä»…ä¾›å‚è€ƒï¼Œå®é™…è´¹ç”¨è¯·ä»¥åŒ»é™¢ä¸ºå‡† | 
                            <span style="color: #005826; font-weight: 500;">ä¼˜å…ˆæ¨èä¸­å±±å¤§å­¦å­™é€¸ä»™çºªå¿µåŒ»é™¢</span>
                        </div>
                    `;
                    
                    cardContainer.innerHTML = cardHTML;
                    parentElement.appendChild(cardContainer);
                }
            } catch (error) {
                console.error('è·å–ä»·æ ¼æ•°æ®å¤±è´¥:', error);
            }
        }

        // é¢„çº¦åŒ»é™¢ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
        function bookHospital(hospitalName, checkItem) {
            alert(`æ­£åœ¨ä¸ºæ‚¨é¢„çº¦ ${hospitalName} çš„ ${checkItem} æ£€æŸ¥...\n\né¢„çº¦åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼`);
        }

        // æŸ¥çœ‹åŒ»é™¢è¯¦æƒ…ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
        function viewHospitalDetails(hospitalName) {
            alert(`æŸ¥çœ‹ ${hospitalName} è¯¦ç»†ä¿¡æ¯...\n\nè¯¦æƒ…åŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼`);
        }

        // å°†æ¶ˆæ¯æ·»åŠ åˆ°DOM
        function addMessageToDOM(type, content, imageUrl = null) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (type === 'user') {
                avatar.innerHTML = '<i class="fas fa-user"></i>';
            } else {
                avatar.innerHTML = '<img src="/static/images/owl-mascot.png" alt="å°é¹°" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">';
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const text = document.createElement('div');
            text.textContent = content;
            text.style.whiteSpace = 'pre-wrap';
            contentDiv.appendChild(text);

            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.className = 'message-image';
                img.onclick = () => window.open(imageUrl, '_blank');
                contentDiv.appendChild(img);
            }

            // å¦‚æœæ˜¯AIå›å¤ï¼Œæ£€æµ‹æ£€æŸ¥é¡¹ç›®å¹¶æ¸²æŸ“ä»·æ ¼å¡ç‰‡
            if (type === 'assistant') {
                const checkItems = detectCheckItems(content);
                if (checkItems.length > 0) {
                    // ä¸ºæ¯ä¸ªæ£€æµ‹åˆ°çš„é¡¹ç›®æ¸²æŸ“ä»·æ ¼å¡ç‰‡
                    checkItems.forEach(item => {
                        renderPriceCard(item, contentDiv);
                    });
                }
            }

            const time = document.createElement('div');
            time.className = 'message-time';
            time.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            contentDiv.appendChild(time);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';

            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <img src="/static/images/owl-mascot.png" alt="å°é¹°" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;

            messagesContainer.appendChild(typingDiv);
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            const initialView = document.getElementById('initialView');
            if (initialView) {
                initialView.classList.add('hidden');
            }

            addMessage('user', message);
            input.value = '';
            autoResize(input);

            // è°ƒç”¨AIå›å¤
            setTimeout(async () => {
                showTypingIndicator();
                const response = await generateResponse(message);
                hideTypingIndicator();
                addMessage('assistant', response);
            }, 300);
        }

// è°ƒç”¨AIç”Ÿæˆå›å¤ï¼ˆæ”¯æŒå›¾ç‰‡ï¼‰
        async function generateResponse(message, imageBase64 = null) {
            try {
                const requestBody = { message: message };
                if (imageBase64) {
                    requestBody.image = imageBase64;
                }
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    return data.response;
                } else {
                    return 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›å¤ã€‚è¯·ç¨åå†è¯•ã€‚é”™è¯¯ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                console.error('è°ƒç”¨AIæ¥å£å¤±è´¥:', error);
                return 'æŠ±æ­‰ï¼Œç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚';
            }
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const initialView = document.getElementById('initialView');
                if (initialView) {
                    initialView.classList.add('hidden');
                }

                const imageBase64 = e.target.result;
                addMessage('user', 'æˆ‘ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡', imageBase64);

                setTimeout(async () => {
                    showTypingIndicator();
                    const response = await generateResponse('è¯·å¸®æˆ‘åˆ†æè¿™å¼ ä½“æ£€æŠ¥å‘Šï¼Œé‡ç‚¹å…³æ³¨å¼‚å¸¸æŒ‡æ ‡å’Œå¥åº·é£é™©ã€‚', imageBase64);
                    hideTypingIndicator();
                    addMessage('assistant', response);
                }, 300);
            };
            reader.readAsDataURL(file);

            event.target.value = '';
        }

        // è¯­éŸ³è¯†åˆ«ç›¸å…³å˜é‡
        let recognition = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        function initSpeechRecognition() {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb Speech API
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN'; // è®¾ç½®ä¸­æ–‡è¯†åˆ«
                recognition.continuous = false; // å•æ¬¡è¯†åˆ«
                recognition.interimResults = false; // ä¸è¿”å›ä¸´æ—¶ç»“æœ
                
                recognition.onstart = function() {
                    console.log('è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨');
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    console.log('è¯†åˆ«ç»“æœ:', transcript);
                    
                    // å°†è¯†åˆ«ç»“æœå¡«å…¥è¾“å…¥æ¡†
                    const messageInput = document.getElementById('messageInput');
                    messageInput.value = transcript;
                    autoResize(messageInput);
                    
                    // è‡ªåŠ¨å‘é€æ¶ˆæ¯
                    setTimeout(() => {
                        sendMessage();
                    }, 500);
                };
                
                recognition.onerror = function(event) {
                    console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                    alert('è¯­éŸ³è¯†åˆ«å¤±è´¥: ' + event.error + '\nè¯·æ£€æŸ¥éº¦å…‹é£æƒé™æˆ–å°è¯•å…¶ä»–è¾“å…¥æ–¹å¼');
                    const voiceBtn = document.getElementById('voiceBtn');
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    isRecording = false;
                };
                
                recognition.onend = function() {
                    console.log('è¯­éŸ³è¯†åˆ«å·²ç»“æŸ');
                    const voiceBtn = document.getElementById('voiceBtn');
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    isRecording = false;
                };
            }
        }

        // è¯­éŸ³å½•åˆ¶åŠŸèƒ½
        function toggleVoiceRecording() {
            const voiceBtn = document.getElementById('voiceBtn');
            
            if (!isRecording) {
                // å¼€å§‹å½•éŸ³
                isRecording = true;
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
                
                // ä¼˜å…ˆä½¿ç”¨Web Speech API
                if (recognition) {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('æ— æ³•å¯åŠ¨è¯­éŸ³è¯†åˆ«:', e);
                        alert('æ— æ³•å¯åŠ¨è¯­éŸ³è¯†åˆ«ï¼Œè¯·ç¡®ä¿å·²æˆæƒéº¦å…‹é£æƒé™');
                        voiceBtn.classList.remove('recording');
                        voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                        isRecording = false;
                    }
                } else {
                    // æµè§ˆå™¨ä¸æ”¯æŒWeb Speech API
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½\nå»ºè®®ä½¿ç”¨Chromeã€Edgeæˆ–Safariæµè§ˆå™¨');
                    voiceBtn.classList.remove('recording');
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    isRecording = false;
                }
            } else {
                // åœæ­¢å½•éŸ³
                if (recognition) {
                    recognition.stop();
                }
                isRecording = false;
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
        }

        // å¤„ç†å›è½¦å‘é€
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }
    </script>
</body>

</html>